name: Atualizar dados ArcosLand (Pages)

on:
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *'   # a cada 5 min
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'public/**'         # evita re-disparo por commits da pasta gerada

concurrency:
  group: arcosland-pages
  cancel-in-progress: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    env:
      RTDB_URL: "https://arcosland-90ad2-default-rtdb.firebaseio.com/aquario.json"
      OUT_DIR: "public"
      BASE_URL: "https://arcosland.pages.dev"

    steps:
      - name: Checkout (shallow)
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Criar pasta de scripts (se não existir)
        run: mkdir -p .github/scripts

      - name: Colocar script no workspace (caso ainda não esteja no repo)
        # se você já versionou o generate.js no repositório, pode remover este step
        shell: bash
        run: |
          if [ ! -f ".github/scripts/generate.js" ]; then
            cat > .github/scripts/generate.js <<'JS'
            // placeholder: você já deve ter criado este arquivo no passo 1
            console.error("FALTA o arquivo .github/scripts/generate.js no repo.");
            process.exit(2);
            JS
          fi

      - name: Rodar gerador
        run: node .github/scripts/generate.js

      - name: Detectar alterações
        id: changes
        shell: bash
        run: |
          if git status --porcelain | grep -qE "${OUT_DIR}/(current\.txt|txt|data\.json|index\.html|_headers|robots\.txt|sitemap\.xml)"; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit & Push (se mudou)
        if: steps.changes.outputs.changed == 'true'
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add ${OUT_DIR}/current.txt ${OUT_DIR}/txt ${OUT_DIR}/data.json ${OUT_DIR}/index.html ${OUT_DIR}/_headers ${OUT_DIR}/robots.txt ${OUT_DIR}/sitemap.xml
          git commit -m "chore: atualizar dados (CI)"
          git push
