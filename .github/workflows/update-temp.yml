- name: Gerar arquivos (current.txt, txt, data.json, index.html)
  run: |
    node - <<'NODE'
    const https = require('https');
    const fs = require('fs');
    const path = require('path');

    const RTDB_URL = "https://arcosland-90ad2-default-rtdb.firebaseio.com/aquario.json";

    // FunÃ§Ã£o para buscar JSON do Firebase
    function fetchJSON(url) {
      return new Promise((resolve, reject) => {
        https.get(url, { headers: { 'Accept': 'application/json' } }, (res) => {
          let data = '';
          res.on('data', d => data += d);
          res.on('end', () => {
            try { resolve(JSON.parse(data)); }
            catch (e) { reject(e); }
          });
        }).on('error', reject);
      });
    }

    // Subtrai 1Â°C em todos os campos .value numÃ©ricos
    function minusOneDeg(obj) {
      if (obj === null || typeof obj !== 'object') return obj;
      if (Array.isArray(obj)) return obj.map(minusOneDeg);
      const out = {};
      for (const k of Object.keys(obj)) {
        const v = obj[k];
        if (k === 'value' && typeof v === 'number' && Number.isFinite(v)) {
          out[k] = Number((v - 1).toFixed(2));
        } else if (v && typeof v === 'object') {
          out[k] = minusOneDeg(v);
        } else {
          out[k] = v;
        }
      }
      return out;
    }

    // Converte objeto em lista key=value
    function flattenKV(obj, prefix = "", lines = []) {
      if (obj === null || typeof obj !== "object") {
        const key = prefix.replace(/\.$/, "");
        lines.push(`${key}=${String(obj)}`);
        return lines;
      }
      const keys = Object.keys(obj).sort();
      for (const k of keys) {
        const v = obj[k];
        const p = prefix ? `${prefix}.${k}` : k;
        if (v !== null && typeof v === "object") {
          flattenKV(v, p, lines);
        } else {
          lines.push(`${p}=${String(v)}`);
        }
      }
      return lines;
    }

    (async () => {
      const raw = await fetchJSON(RTDB_URL);
      const adj = minusOneDeg(raw);

      const pub = path.join(process.cwd(), 'public');
      if (!fs.existsSync(pub)) fs.mkdirSync(pub, { recursive: true });

      // current.txt
      const current = adj?.current?.value;
      const currentStr = (typeof current === 'number' && Number.isFinite(current))
        ? current.toFixed(2)
        : 'N/A';
      fs.writeFileSync(path.join(pub, 'current.txt'), currentStr, 'utf-8');

      // txt (chave=valor)
      const lines = flattenKV(adj);
      fs.writeFileSync(path.join(pub, 'txt'), lines.join('\n') + '\n', 'utf-8');

      // data.json (json completo)
      fs.writeFileSync(path.join(pub, 'data.json'), JSON.stringify(adj, null, 2) + '\n', 'utf-8');

      // index.html (HTML simples exibindo JSON inteiro)
      const html = `<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>ArcosLand â€“ Dados do AquÃ¡rio</title>
  <style>
    body { font-family: monospace; background: #f8f9fa; padding: 20px; }
    h1 { font-family: sans-serif; text-align: center; }
    pre { background: #fff; padding: 16px; border-radius: 8px; overflow-x: auto; box-shadow: 0 0 6px #ccc; }
    small { display: block; text-align: center; color: #555; margin-top: 1em; }
  </style>
</head>
<body>
  <h1>ðŸŒ¿ ArcosLand â€“ Dados Atuais do AquÃ¡rio</h1>
  <pre>${JSON.stringify(adj, null, 2)}</pre>
  <small>Atualizado automaticamente via GitHub Actions</small>
</body>
</html>`;
      fs.writeFileSync(path.join(pub, 'index.html'), html, 'utf-8');

      console.log("Arquivos gerados com sucesso:");
      console.log("- public/current.txt");
      console.log("- public/txt");
      console.log("- public/data.json");
      console.log("- public/index.html");
    })().catch(err => {
      console.error(err);
      process.exit(1);
    });
    NODE
